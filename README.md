<p align="center"> 
<img width="800" src="http://blindeyesoftworks.com/github/media/ifeobanner.gif" alt="IEFO Exploit Banner"> 
</p> 

<h1 align="center">IFEO Exploit Payload Sample</h1> 

An in-depth look at a malicious payload using Windows Image File Execution Options (IFEO) as an attack vector for executing
Denial of Service (DoS) attacks on system programs.

## Analysis: 
Windows enables power users to automatically attach debuggers to invoked programs through the use of IFEO. IFEO is a feature
that can be found in Windows NT operating systems version 5.0 (Windows 2000) and later. The Windows kernel, upon program
invocation, will perform a preliminary check inside of the local machines registry hive containing the IFEO as a penultimate
step prior to creating the process. Using programs shipped with Windows such as the Registry Editor, Command Prompt, and
PowerShell, or other programs making use of the Windows API, users may access the IFEO subkey containing several subkeys
representing programs.

#### IFEO Subkey Path:
*`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options`*

![Visual inspection of the IEFO subkey.](http://blindeyesoftworks.com/github/media/ifeo.png)

By creating and opening a program subkey, or opening a pre-existing program subkey, a string value can be created with the
name *`Debugger`* and its data can then be set to the path of a debugger. 

  

<p align="center">
<img width="380" src="http://blindeyesoftworks.com/github/media/ifeostring.png" alt="Debugger String Key">
</p>

While serving purpose for legitimate uses IFEO can also be used undesirably as well, creating an attack vector for malicious
programs to execute DoS attacks on both installed and core system programs in aid of creating ransomware and other forms of
malware. Threat actors can also use IFEO to register their own values in place of a debugger to avoid detection, make removal
difficult, trick victims into elevating privileges, or disabling core system programs; making Windows unstable and rendering
the OS inoperable. Exploiting IFEO requires a threat actor to gain administrative permissions in order to modify the HKLM registry
hive and can be done by widening the attack surface, i.e., the inclusion of other attack vectors such as social engineering or
User Account Control (UAC) bypasses. At this point, a threat actor already has full control of a victim's system.

## Reversing Modifications:

If a victim can access the HKLM registry hive the modifications can easily be reversed. If access is not possible, victims can create
a copy of the HKLM hive file and, on a separate system, load the hive file to reverse the modifications.

## Mitigation:

User awareness is the first step in preventing threat actors from being able to execute malicious tasks on a system, though user
awareness is not always possible hence the existence of antivirus (AV) software and firewalls. Though these types of attacks are
not common and are easily detected by current generation AV software or groups such as Microsoft Security Intelligence, steps should
be taken to prevent and recoup from an attack. This requires that users ensure they have the latest definitions from their AV vendor
and to also create regular registry backups. Windows 10 version 1709 and earlier major releases automatically create registry hive file
backups located in *`%WINDIR%\System32\config\RegBack`*. Starting with Windows 10 version 1803, Microsoft has purposely disabled automatic
registry hive file backups in attempt to lower the overall disk footprint of Windows. However, by modifying a flag within the HKLM hive
this feature can be restored and is also recommended for reasons beyond the scope of this document.

Enabling automatic registry hive file backups requires modifying the *Configuration Manager* subkey:
*`HKLM\System\CurrentControlSet\Control\Session Manager\Configuration Manager`*

This subkey contains a 32-bit integer value with *`EnablePeriodicBackup`* as the given name. Setting this flag to *`1`* will enable registry
hive file backups on a set schedule.

![Configuration Manager subkey.](http://blindeyesoftworks.com/github/media/cmsubkey.png)

If this subkey and\or value does not exist, it is safe to create them manually. Once enabled, it is recommended that registry hive file
backups be copied to a seperate location as the RegBack folder can still be purged by a threat actor.

If Windows is still not creating registry hive file backups automatically after modifying the above subkey then the Registry Idle Backup
Task must be enabled and configured. This can be done using the Task Scheduler program which ships with all Windows installations. The
path to the Registry Idle Backup task is *`Task Scheduler Library\Microsoft\Windows\Registry`*.

![Configuring the Registry Idle Backup Task.](http://blindeyesoftworks.com/github/media/regidlebackup.png)

If is also worth mentioning that some attacks could be negated entirely if the Windows kernel were to still execute the invoked program if a
debugger could not be located. This is a flaw that Microsoft, even today, does not consider a vulnerability. It is also safe to assume the
former given the long existence of the flaw and lack of proper testing. Though Microsoft may not deem the flaw as a vulnerability, the
National Information Assurance Training and Education Center (NIATEC) says otherwise:

*"A weakness in automated system security procedures, administrative controls, internal controls, and so forth, that could be exploited by a threat to gain unauthorized access to information or **disrupt critical processing**. (AFR 700-10;; AFR 205-16;; AR 380-380;) 2. A weakness in system security procedures, hardware design, internal controls, etc. , which could be exploited to gain unauthorized access to classified or sensitive information. (NCSC-WA-001-85;) 3. A weakness in the physical layout, organization, procedures, personnel, management, administration, hardware, or software that may be exploited to cause harm to the ADP system or activity. The presence of a vulnerability does not in itself cause harm; a vulnerability is merely a condition or set of conditions that may allow the ADP system or activity to be harmed by an attack. (OPNAVINST 5239. 1A;) 4. An assertion primarily concerning entities of the internal environment (assets); we say that an asset (or class of assets) is vulnerable (in some way, possibly involving an agent or collection of agents); we write: V(i,e) where: e may be an empty set. (ET;) 5. Susceptibility to various threats. (RM;) 6. A set of properties of a specific internal entity that, in union with a set of properties of a specific external entity, implies a risk. (MK;) 7. The characteristics of a system which cause it to suffer a definite degradation (incapability to perform the designated mission) as a result of having been subjected to a certain level of effects in an unnatural (manmade) hostile environment. (JP 1-02) (AF MAN 33-270)"* - **NIATEC**
